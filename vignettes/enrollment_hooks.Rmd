---
title: "15 Insights from Nebraska School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{15 Insights from Nebraska School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
```

```{r packages}
library(neschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_minimal(base_size = 14))
```

## Nebraska enrollment hit an all-time high in 2024

Bucking national trends, Nebraska keeps growing. **+47,000 students** (+17%) in 19 years.

```{r statewide-data}
enr <- fetch_enr_multi(c(2005, 2010, 2015, 2020, 2024), use_cache = TRUE)

statewide <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, n_students)

statewide
```

```{r statewide-chart}
ggplot(statewide, aes(x = end_year, y = n_students)) +
  geom_line(color = "#2563eb", linewidth = 1.2) +
  geom_point(color = "#2563eb", size = 3) +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA)) +
  labs(
    title = "Nebraska K-12 Enrollment (2005-2024)",
    subtitle = "Total public school enrollment continues to grow",
    x = "Year",
    y = "Students"
  )
```

## Omaha and Lincoln together are half the state

The two cities dominate Nebraska education. **Omaha + Lincoln: 95,000 students** (29% of the state).

```{r top-districts-data}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

top_districts <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  head(8) %>%
  select(district_name, n_students)

top_districts
```

```{r top-districts-chart}
top_districts %>%
  mutate(district_name = reorder(district_name, n_students)) %>%
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#2563eb") +
  scale_x_continuous(labels = scales::comma) +
  labs(
    title = "Top 8 Nebraska School Districts by Enrollment (2024)",
    subtitle = "Omaha and Lincoln dominate state enrollment",
    x = "Students",
    y = NULL
  )
```

## Hispanic enrollment has more than doubled since 2005

Nebraska's demographic transformation mirrors national patterns. Hispanic students: **28,000 to 77,000** (+173%).

```{r demographics-data}
demographics <- enr %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "hispanic", "black", "asian")) %>%
  select(end_year, subgroup, n_students)

demographics %>%
  pivot_wider(names_from = subgroup, values_from = n_students)
```

```{r demographics-chart}
demographics %>%
  mutate(subgroup = factor(subgroup,
                           levels = c("white", "hispanic", "black", "asian"),
                           labels = c("White", "Hispanic", "Black", "Asian"))) %>%
  ggplot(aes(x = end_year, y = n_students, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("White" = "#6b7280", "Hispanic" = "#f59e0b",
                                "Black" = "#10b981", "Asian" = "#8b5cf6")) +
  labs(
    title = "Nebraska Enrollment by Race/Ethnicity (2005-2024)",
    subtitle = "Hispanic enrollment has more than doubled while White enrollment declined",
    x = "Year",
    y = "Students",
    color = "Race/Ethnicity"
  )
```

## Elkhorn is Nebraska's growth machine

This Omaha suburb can't build schools fast enough. **+96% growth** since 2010.

```{r suburban-growth-data}
enr_multi <- fetch_enr_multi(2010:2024, use_cache = TRUE)

suburban <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("ELKHORN|MILLARD|PAPILLION", district_name, ignore.case = TRUE)) %>%
  select(end_year, district_name, n_students)

suburban %>%
  filter(end_year %in% c(2010, 2015, 2020, 2024)) %>%
  pivot_wider(names_from = end_year, values_from = n_students)
```

```{r suburban-growth-chart}
ggplot(suburban, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Suburban District Growth (2010-2024)",
    subtitle = "Elkhorn has nearly doubled enrollment since 2010",
    x = "Year",
    y = "Students",
    color = "District"
  )
```

## Rural Nebraska is shrinking

Small-town schools face existential pressure. **13 fewer tiny districts** since 2010.

```{r regional-data}
regional <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  filter(end_year %in% c(2010, 2024)) %>%
  mutate(size = case_when(
    n_students >= 10000 ~ "Large (10,000+)",
    n_students >= 1000 ~ "Medium (1,000-9,999)",
    n_students >= 200 ~ "Small (200-999)",
    TRUE ~ "Tiny (<200)"
  )) %>%
  group_by(end_year, size) %>%
  summarize(n_districts = n(), total_students = sum(n_students), .groups = "drop")

regional %>%
  pivot_wider(names_from = end_year, values_from = c(n_districts, total_students))
```

```{r regional-chart}
regional %>%
  mutate(size = factor(size, levels = c("Tiny (<200)", "Small (200-999)",
                                         "Medium (1,000-9,999)", "Large (10,000+)"))) %>%
  ggplot(aes(x = size, y = total_students, fill = factor(end_year))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("2010" = "#94a3b8", "2024" = "#2563eb")) +
  labs(
    title = "Enrollment by District Size (2010 vs 2024)",
    subtitle = "Large districts grow while small and tiny districts shrink",
    x = "District Size",
    y = "Total Students",
    fill = "Year"
  ) +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))
```

## Omaha Public Schools lost 6,000 students since 2015

Urban enrollment is shifting to the suburbs. **-5,667 students** (-10%) since 2015.

```{r omaha-data}
omaha <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("OMAHA PUBLIC", district_name, ignore.case = TRUE)) %>%
  filter(end_year %in% c(2015, 2018, 2020, 2022, 2024)) %>%
  select(end_year, n_students) %>%
  mutate(change = n_students - lag(n_students))

omaha
```

```{r omaha-chart}
ggplot(omaha, aes(x = end_year, y = n_students)) +
  geom_line(color = "#dc2626", linewidth = 1.2) +
  geom_point(color = "#dc2626", size = 3) +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA)) +
  labs(
    title = "Omaha Public Schools Enrollment (2015-2024)",
    subtitle = "Enrollment has declined steadily as suburbs grow",
    x = "Year",
    y = "Students"
  )
```

## Grade-level shifts: Pre-K grows, Kindergarten shrinks

The pipeline is shifting. Pre-K: **+6,000**. Kindergarten: **-2,200**.

```{r grade-level-data}
grades <- enr_multi %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("PK", "K", "01", "02", "03")) %>%
  filter(end_year %in% c(2015, 2020, 2024)) %>%
  select(end_year, grade_level, n_students)

grades %>%
  pivot_wider(names_from = end_year, values_from = n_students) %>%
  mutate(change_15_24 = `2024` - `2015`)
```

```{r grade-level-chart}
grades %>%
  mutate(grade_level = factor(grade_level,
                              levels = c("PK", "K", "01", "02", "03"),
                              labels = c("Pre-K", "K", "1st", "2nd", "3rd"))) %>%
  ggplot(aes(x = grade_level, y = n_students, fill = factor(end_year))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("2015" = "#94a3b8", "2020" = "#60a5fa", "2024" = "#2563eb")) +
  labs(
    title = "Early Grade Enrollment (2015-2024)",
    subtitle = "Pre-K expands while Kindergarten enrollment declines",
    x = "Grade Level",
    y = "Students",
    fill = "Year"
  )
```

## Grand Island is Nebraska's most diverse city

The meatpacking industry transformed this central Nebraska town. **49% Hispanic** - Grand Island flipped from majority-white to majority-Hispanic in 20 years.

```{r grand-island-data}
grand_island <- enr_2024 %>%
  filter(grepl("GRAND ISLAND", district_name, ignore.case = TRUE), is_district,
         grade_level == "TOTAL",
         subgroup %in% c("white", "hispanic", "black", "asian")) %>%
  mutate(pct = round(n_students / sum(n_students) * 100, 1)) %>%
  select(subgroup, n_students, pct) %>%
  arrange(desc(pct))

grand_island
```

```{r grand-island-chart}
grand_island %>%
  mutate(subgroup = factor(subgroup,
                           levels = c("hispanic", "white", "black", "asian"),
                           labels = c("Hispanic", "White", "Black", "Asian"))) %>%
  ggplot(aes(x = reorder(subgroup, -pct), y = pct, fill = subgroup)) +
  geom_col() +
  scale_fill_manual(values = c("Hispanic" = "#f59e0b", "White" = "#6b7280",
                               "Black" = "#10b981", "Asian" = "#8b5cf6")) +
  labs(
    title = "Grand Island Public Schools Demographics (2024)",
    subtitle = "Nearly half of students are Hispanic",
    x = NULL,
    y = "Percent of Enrollment"
  ) +
  theme(legend.position = "none")
```

## COVID accelerated suburban growth

The pandemic pushed families out of Omaha faster. Omaha: **-4%**. Elkhorn: **+6%**.

```{r covid-data}
covid <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("OMAHA PUBLIC|MILLARD|ELKHORN|PAPILLION", district_name, ignore.case = TRUE),
         end_year %in% c(2019, 2021)) %>%
  select(district_name, end_year, n_students) %>%
  pivot_wider(names_from = end_year, values_from = n_students) %>%
  rename(y2019 = `2019`, y2021 = `2021`) %>%
  mutate(pct_change = round((y2021 - y2019) / y2019 * 100, 1)) %>%
  arrange(pct_change)

covid
```

```{r covid-chart}
covid %>%
  ggplot(aes(x = reorder(district_name, pct_change), y = pct_change,
             fill = pct_change > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "#10b981", "FALSE" = "#dc2626")) +
  labs(
    title = "Enrollment Change During COVID (2019-2021)",
    subtitle = "Urban districts lost students while suburbs grew",
    x = NULL,
    y = "Percent Change"
  ) +
  theme(legend.position = "none")
```

## Hispanic enrollment is nearly a quarter of the state

Nebraska schools serve a growing multilingual population. **23% Hispanic** statewide.

```{r diversity-data}
diversity <- enr_2024 %>%
  filter(is_state, grade_level == "TOTAL") %>%
  filter(subgroup %in% c("total_enrollment", "hispanic", "white", "black", "asian")) %>%
  select(subgroup, n_students) %>%
  mutate(pct = round(n_students / max(n_students) * 100, 1))

diversity
```

```{r diversity-chart}
diversity %>%
  filter(subgroup != "total_enrollment") %>%
  mutate(subgroup = factor(subgroup,
                           levels = c("white", "hispanic", "black", "asian"),
                           labels = c("White", "Hispanic", "Black", "Asian"))) %>%
  ggplot(aes(x = reorder(subgroup, -pct), y = pct, fill = subgroup)) +
  geom_col() +
  scale_fill_manual(values = c("White" = "#6b7280", "Hispanic" = "#f59e0b",
                               "Black" = "#10b981", "Asian" = "#8b5cf6")) +
  labs(
    title = "Nebraska Statewide Demographics (2024)",
    subtitle = "Hispanic students now make up nearly a quarter of enrollment",
    x = NULL,
    y = "Percent of Enrollment"
  ) +
  theme(legend.position = "none")
```

## Lexington became majority-Hispanic through meatpacking

Tyson Foods transformed this small town in central Nebraska. Today **over 80%** of Lexington Public Schools students are Hispanic.

```{r lexington-data}
lexington <- enr_multi %>%
  filter(is_district, grepl("LEXINGTON", district_name, ignore.case = TRUE),
         grade_level == "TOTAL",
         subgroup %in% c("white", "hispanic", "total_enrollment")) %>%
  select(end_year, subgroup, n_students) %>%
  pivot_wider(names_from = subgroup, values_from = n_students) %>%
  mutate(hispanic_pct = round(hispanic / total_enrollment * 100, 1))

lexington %>%
  filter(end_year %in% c(2010, 2015, 2020, 2024))
```

```{r lexington-chart}
ggplot(lexington, aes(x = end_year, y = hispanic_pct)) +
  geom_line(color = "#f59e0b", linewidth = 1.2) +
  geom_point(color = "#f59e0b", size = 3) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    title = "Lexington Public Schools: Hispanic Enrollment %",
    subtitle = "Meatpacking transformed this central Nebraska community",
    x = "Year",
    y = "Hispanic %"
  )
```

## Lincoln is gaining on Omaha

While Omaha shrinks, Lincoln keeps growing. Lincoln Public Schools added **8,000+ students** since 2010.

```{r lincoln-vs-omaha-data}
two_cities <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("OMAHA PUBLIC|LINCOLN PUBLIC", district_name, ignore.case = TRUE)) %>%
  mutate(city = if_else(grepl("OMAHA", district_name, ignore.case = TRUE), "Omaha", "Lincoln")) %>%
  select(end_year, city, n_students)

two_cities %>%
  pivot_wider(names_from = city, values_from = n_students) %>%
  filter(end_year %in% c(2010, 2015, 2020, 2024)) %>%
  mutate(gap = Omaha - Lincoln)
```

```{r lincoln-vs-omaha-chart}
ggplot(two_cities, aes(x = end_year, y = n_students, color = city)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::comma) +
  scale_color_manual(values = c("Omaha" = "#dc2626", "Lincoln" = "#2563eb")) +
  labs(
    title = "Omaha vs Lincoln Enrollment (2010-2024)",
    subtitle = "Lincoln grows steadily while Omaha declines",
    x = "Year",
    y = "Students",
    color = "District"
  )
```

## High school is more diverse than elementary

Nebraska's demographic shift shows up in grade-level differences. Elementary is **28% Hispanic** while high school is only **20%**.

```{r hs-diversity-data}
grade_diversity <- enr_2024 %>%
  filter(is_state, subgroup %in% c("white", "hispanic", "black", "asian"),
         grade_level %in% c("K", "05", "08", "12")) %>%
  group_by(grade_level) %>%
  mutate(pct = round(n_students / sum(n_students) * 100, 1)) %>%
  ungroup() %>%
  select(grade_level, subgroup, pct)

grade_diversity %>%
  pivot_wider(names_from = grade_level, values_from = pct)
```

```{r hs-diversity-chart}
grade_diversity %>%
  mutate(
    grade_level = factor(grade_level,
                         levels = c("K", "05", "08", "12"),
                         labels = c("Kindergarten", "5th Grade", "8th Grade", "12th Grade")),
    subgroup = factor(subgroup,
                      levels = c("white", "hispanic", "black", "asian"),
                      labels = c("White", "Hispanic", "Black", "Asian"))
  ) %>%
  ggplot(aes(x = grade_level, y = pct, fill = subgroup)) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("White" = "#6b7280", "Hispanic" = "#f59e0b",
                               "Black" = "#10b981", "Asian" = "#8b5cf6")) +
  labs(
    title = "Demographics by Grade Level (2024)",
    subtitle = "Younger grades are more diverse than older grades",
    x = "Grade Level",
    y = "Percent of Enrollment",
    fill = "Race/Ethnicity"
  )
```

## The I-80 corridor is booming

Districts along Interstate 80 from Omaha to Kearney are growing, while the rest of rural Nebraska shrinks.

```{r i80-data}
# Major I-80 districts: Omaha metro, Lincoln, Grand Island, Kearney
i80_districts <- c("OMAHA", "LINCOLN", "MILLARD", "PAPILLION", "BELLEVUE",
                   "ELKHORN", "GRAND ISLAND", "KEARNEY")

i80_growth <- enr_multi %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year %in% c(2010, 2024)) %>%
  mutate(is_i80 = any(sapply(i80_districts, function(x) grepl(x, district_name, ignore.case = TRUE)))) %>%
  group_by(end_year, is_i80) %>%
  summarize(total = sum(n_students), n_districts = n(), .groups = "drop") %>%
  mutate(region = if_else(is_i80, "I-80 Corridor", "Rest of State"))

i80_growth %>%
  select(end_year, region, total, n_districts) %>%
  pivot_wider(names_from = end_year, values_from = c(total, n_districts))
```

```{r i80-chart}
i80_growth %>%
  ggplot(aes(x = region, y = total, fill = factor(end_year))) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("2010" = "#94a3b8", "2024" = "#2563eb")) +
  labs(
    title = "I-80 Corridor vs Rest of State (2010 vs 2024)",
    subtitle = "Growth concentrated along the interstate highway",
    x = NULL,
    y = "Total Students",
    fill = "Year"
  )
```

## Native American enrollment in Western Nebraska

Pine Ridge Reservation overlaps into Nebraska. Chadron and other western districts serve significant Native populations.

```{r native-data}
# Look at districts with notable Native American populations
native_districts <- enr_2024 %>%
  filter(is_district, grade_level == "TOTAL",
         subgroup == "native_american") %>%
  arrange(desc(n_students)) %>%
  head(10) %>%
  select(district_name, n_students)

# Get total enrollment for these districts to calculate percentages
native_pct <- enr_2024 %>%
  filter(is_district, grade_level == "TOTAL",
         subgroup %in% c("total_enrollment", "native_american"),
         district_name %in% native_districts$district_name) %>%
  select(district_name, subgroup, n_students) %>%
  pivot_wider(names_from = subgroup, values_from = n_students) %>%
  mutate(pct = round(native_american / total_enrollment * 100, 1)) %>%
  arrange(desc(pct)) %>%
  head(8)

native_pct
```

```{r native-chart}
native_pct %>%
  mutate(district_name = reorder(district_name, pct)) %>%
  ggplot(aes(x = pct, y = district_name)) +
  geom_col(fill = "#dc2626") +
  labs(
    title = "Districts with Highest Native American Enrollment (2024)",
    subtitle = "Western Nebraska districts near Pine Ridge Reservation",
    x = "Native American %",
    y = NULL
  )
```

## Session Info

```{r session-info}
sessionInfo()
```
